<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelé¢˜åº“è½¬æ¢å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #1f2937;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .card h2 {
            font-size: 18px;
            color: #374151;
            margin-bottom: 16px;
        }
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-area:hover {
            border-color: #4f46e5;
            background: #f5f3ff;
        }
        .upload-area.dragover {
            border-color: #4f46e5;
            background: #eef2ff;
        }
        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .upload-text {
            color: #6b7280;
            margin-bottom: 8px;
        }
        .upload-hint {
            font-size: 14px;
            color: #9ca3af;
        }
        input[type="file"] {
            display: none;
        }
        .mapping-section {
            display: none;
        }
        .mapping-section.show {
            display: block;
        }
        .mapping-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .mapping-label {
            width: 120px;
            font-size: 14px;
            color: #374151;
        }
        .mapping-select {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background: #4338ca;
        }
        .btn-primary:disabled {
            background: #c7d2fe;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        .btn-secondary:hover {
            background: #d1d5db;
        }
        .output-area {
            background: #1f2937;
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
        }
        .output-area pre {
            color: #e5e7eb;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 16px;
        }
        .preview-table th,
        .preview-table td {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            text-align: left;
        }
        .preview-table th {
            background: #f9fafb;
            font-weight: 600;
        }
        .preview-table tbody tr:hover {
            background: #f9fafb;
        }
        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .format-hint {
            background: #fef3c7;
            border-radius: 8px;
            padding: 16px;
            font-size: 14px;
            color: #92400e;
            margin-bottom: 16px;
        }
        .format-hint code {
            background: #fde68a;
            padding: 2px 6px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š Excelé¢˜åº“è½¬æ¢å·¥å…·</h1>
        
        <div class="card">
            <h2>1. ä¸Šä¼ Excelæ–‡ä»¶</h2>
            <div class="format-hint">
                <strong>Excelæ ¼å¼è¦æ±‚ï¼š</strong><br>
                å»ºè®®åŒ…å«åˆ—ï¼šé¢˜å·ã€é¢˜å‹ï¼ˆå•é€‰/å¤šé€‰ï¼‰ã€åˆ†ç±»ã€é¢˜ç›®ã€é€‰é¡¹Aã€é€‰é¡¹Bã€é€‰é¡¹Cã€é€‰é¡¹Dã€ç­”æ¡ˆï¼ˆå¦‚Aã€Bã€ABCï¼‰ã€è§£æ<br>
                ç­”æ¡ˆåˆ—ä½¿ç”¨å­—æ¯è¡¨ç¤ºï¼Œå¦‚ï¼š<code>A</code> <code>B</code> <code>ABC</code> <code>ACD</code>
            </div>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</div>
                <div class="upload-hint">æ”¯æŒ .xlsx, .xls, .csv æ ¼å¼</div>
            </div>
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
        </div>

        <div class="card mapping-section" id="mappingSection">
            <h2>2. åˆ—æ˜ å°„é…ç½®</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 16px;">
                è¯·é€‰æ‹©Excelä¸­å¯¹åº”çš„åˆ—ï¼Œä¸éœ€è¦çš„å­—æ®µå¯ä»¥é€‰æ‹©"ä¸ä½¿ç”¨"
            </p>
            
            <div class="mapping-row">
                <span class="mapping-label">é¢˜ç›®IDåˆ—ï¼š</span>
                <select class="mapping-select" id="mapId">
                    <option value="">è‡ªåŠ¨ç”Ÿæˆ</option>
                </select>
            </div>
            <div class="mapping-row">
                <span class="mapping-label">é¢˜å‹åˆ—ï¼š</span>
                <select class="mapping-select" id="mapType">
                    <option value="">ä¸ä½¿ç”¨ï¼ˆé»˜è®¤å•é€‰ï¼‰</option>
                </select>
            </div>
            <div class="mapping-row">
                <span class="mapping-label">åˆ†ç±»åˆ—ï¼š</span>
                <select class="mapping-select" id="mapCategory">
                    <option value="">ä¸ä½¿ç”¨</option>
                </select>
            </div>
            <div class="mapping-row">
                <span class="mapping-label">é¢˜ç›®å†…å®¹åˆ—ï¼š</span>
                <select class="mapping-select" id="mapQuestion" required>
                    <option value="">è¯·é€‰æ‹©</option>
                </select>
            </div>
            <div class="mapping-row">
                <span class="mapping-label">é€‰é¡¹Aåˆ—ï¼š</span>
                <select class="mapping-select" id="mapOptionA" required>
                    <option value="">è¯·é€‰æ‹©</option>
                </select>
            </div>
            <div class="mapping-row">
                <span class="mapping-label">é€‰é¡¹Båˆ—ï¼š</span>
                <select class="mapping-select" id="mapOptionB" required>
                    <option value="">è¯·é€‰æ‹©</option>
                </select>
            </div>
            <div class="mapping-row">
                <span class="mapping-label">é€‰é¡¹Cåˆ—ï¼š</span>
                <select class="mapping-select" id="mapOptionC">
                    <option value="">ä¸ä½¿ç”¨</option>
                </select>
            </div>
            <div class="mapping-row">
                <span class="mapping-label">é€‰é¡¹Dåˆ—ï¼š</span>
                <select class="mapping-select" id="mapOptionD">
                    <option value="">ä¸ä½¿ç”¨</option>
                </select>
            </div>
            <div class="mapping-row">
                <span class="mapping-label">é€‰é¡¹Eåˆ—ï¼š</span>
                <select class="mapping-select" id="mapOptionE">
                    <option value="">ä¸ä½¿ç”¨</option>
                </select>
            </div>
            <div class="mapping-row">
                <span class="mapping-label">é€‰é¡¹Fåˆ—ï¼š</span>
                <select class="mapping-select" id="mapOptionF">
                    <option value="">ä¸ä½¿ç”¨</option>
                </select>
            </div>
            <div class="mapping-row">
                <span class="mapping-label">ç­”æ¡ˆåˆ—ï¼š</span>
                <select class="mapping-select" id="mapAnswer" required>
                    <option value="">è¯·é€‰æ‹©</option>
                </select>
            </div>
            <div class="mapping-row">
                <span class="mapping-label">è§£æåˆ—ï¼š</span>
                <select class="mapping-select" id="mapExplanation">
                    <option value="">ä¸ä½¿ç”¨</option>
                </select>
            </div>
            
            <h3 style="margin-top: 24px; margin-bottom: 12px; font-size: 16px;">æ•°æ®é¢„è§ˆï¼ˆå‰5è¡Œï¼‰</h3>
            <div style="overflow-x: auto;">
                <table class="preview-table" id="previewTable"></table>
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="convertData()">è½¬æ¢æ•°æ®</button>
            </div>
        </div>

        <div class="card" id="resultSection" style="display: none;">
            <h2>3. è½¬æ¢ç»“æœ</h2>
            <div class="status" id="statusMessage"></div>
            <div class="output-area">
                <pre id="outputCode"></pre>
            </div>
            <div class="actions">
                <button class="btn btn-primary" onclick="copyCode()">å¤åˆ¶ä»£ç </button>
                <button class="btn btn-secondary" onclick="downloadFile()">ä¸‹è½½ questions.js</button>
            </div>
        </div>
    </div>

    <script>
        let excelData = [];
        let headers = [];
        
        // ä¸Šä¼ åŒºåŸŸç‚¹å‡»
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        
        // æ‹–æ‹½ä¸Šä¼ 
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });
        
        // æ–‡ä»¶é€‰æ‹©
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
        });
        
        // å¤„ç†æ–‡ä»¶
        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        alert('Excelæ–‡ä»¶å†…å®¹ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®ï¼');
                        return;
                    }
                    
                    headers = jsonData[0].map(h => String(h || '').trim());
                    excelData = jsonData.slice(1).filter(row => row.some(cell => cell !== undefined && cell !== ''));
                    
                    updateMappingOptions();
                    showPreview();
                    document.getElementById('mappingSection').classList.add('show');
                    document.getElementById('resultSection').style.display = 'none';
                    
                } catch (err) {
                    alert('æ–‡ä»¶è§£æå¤±è´¥ï¼š' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // æ›´æ–°æ˜ å°„é€‰é¡¹
        function updateMappingOptions() {
            const selects = [
                'mapId', 'mapType', 'mapCategory', 'mapQuestion',
                'mapOptionA', 'mapOptionB', 'mapOptionC', 'mapOptionD',
                'mapOptionE', 'mapOptionF', 'mapAnswer', 'mapExplanation'
            ];
            
            selects.forEach(id => {
                const select = document.getElementById(id);
                const defaultOption = select.options[0].cloneNode(true);
                select.innerHTML = '';
                select.appendChild(defaultOption);
                
                headers.forEach((header, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${index + 1}. ${header}`;
                    select.appendChild(option);
                });
            });
            
            // å°è¯•è‡ªåŠ¨åŒ¹é…
            autoMapColumns();
        }
        
        // è‡ªåŠ¨åŒ¹é…åˆ—
        function autoMapColumns() {
            const mappings = {
                'mapId': ['é¢˜å·', 'id', 'åºå·', 'ç¼–å·'],
                'mapType': ['é¢˜å‹', 'ç±»å‹', 'type'],
                'mapCategory': ['åˆ†ç±»', 'ç±»åˆ«', 'category', 'ç« èŠ‚'],
                'mapQuestion': ['é¢˜ç›®', 'é—®é¢˜', 'question', 'é¢˜å¹²'],
                'mapOptionA': ['é€‰é¡¹a', 'a', 'é€‰é¡¹1', 'optiona'],
                'mapOptionB': ['é€‰é¡¹b', 'b', 'é€‰é¡¹2', 'optionb'],
                'mapOptionC': ['é€‰é¡¹c', 'c', 'é€‰é¡¹3', 'optionc'],
                'mapOptionD': ['é€‰é¡¹d', 'd', 'é€‰é¡¹4', 'optiond'],
                'mapOptionE': ['é€‰é¡¹e', 'e', 'é€‰é¡¹5', 'optione'],
                'mapOptionF': ['é€‰é¡¹f', 'f', 'é€‰é¡¹6', 'optionf'],
                'mapAnswer': ['ç­”æ¡ˆ', 'answer', 'æ­£ç¡®ç­”æ¡ˆ'],
                'mapExplanation': ['è§£æ', 'è§£ç­”', 'explanation', 'è¯´æ˜']
            };
            
            Object.keys(mappings).forEach(selectId => {
                const keywords = mappings[selectId];
                const select = document.getElementById(selectId);
                
                headers.forEach((header, index) => {
                    const headerLower = header.toLowerCase();
                    if (keywords.some(kw => headerLower.includes(kw.toLowerCase()))) {
                        select.value = index;
                    }
                });
            });
        }
        
        // æ˜¾ç¤ºé¢„è§ˆ
        function showPreview() {
            const table = document.getElementById('previewTable');
            let html = '<thead><tr>';
            headers.forEach((h, i) => {
                html += `<th>${i + 1}. ${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            excelData.slice(0, 5).forEach(row => {
                html += '<tr>';
                headers.forEach((_, i) => {
                    html += `<td>${row[i] !== undefined ? row[i] : ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';
            
            table.innerHTML = html;
        }
        
        // è½¬æ¢æ•°æ®
        function convertData() {
            const mapQuestion = document.getElementById('mapQuestion').value;
            const mapAnswer = document.getElementById('mapAnswer').value;
            const mapOptionA = document.getElementById('mapOptionA').value;
            const mapOptionB = document.getElementById('mapOptionB').value;
            
            if (!mapQuestion || !mapAnswer || !mapOptionA || !mapOptionB) {
                alert('è¯·è‡³å°‘é€‰æ‹©ï¼šé¢˜ç›®å†…å®¹ã€é€‰é¡¹Aã€é€‰é¡¹Bã€ç­”æ¡ˆåˆ—ï¼');
                return;
            }
            
            const mapId = document.getElementById('mapId').value;
            const mapType = document.getElementById('mapType').value;
            const mapCategory = document.getElementById('mapCategory').value;
            const mapOptionC = document.getElementById('mapOptionC').value;
            const mapOptionD = document.getElementById('mapOptionD').value;
            const mapOptionE = document.getElementById('mapOptionE').value;
            const mapOptionF = document.getElementById('mapOptionF').value;
            const mapExplanation = document.getElementById('mapExplanation').value;
            
            const questions = [];
            let errorCount = 0;
            
            excelData.forEach((row, index) => {
                try {
                    const question = row[mapQuestion];
                    if (!question) return;
                    
                    // æ„å»ºé€‰é¡¹æ•°ç»„
                    const options = [];
                    if (mapOptionA && row[mapOptionA]) options.push(String(row[mapOptionA]).trim());
                    if (mapOptionB && row[mapOptionB]) options.push(String(row[mapOptionB]).trim());
                    if (mapOptionC && row[mapOptionC]) options.push(String(row[mapOptionC]).trim());
                    if (mapOptionD && row[mapOptionD]) options.push(String(row[mapOptionD]).trim());
                    if (mapOptionE && row[mapOptionE]) options.push(String(row[mapOptionE]).trim());
                    if (mapOptionF && row[mapOptionF]) options.push(String(row[mapOptionF]).trim());
                    
                    if (options.length < 2) return;
                    
                    // è§£æç­”æ¡ˆ
                    const answerStr = String(row[mapAnswer] || '').toUpperCase().trim();
                    let answer = parseAnswer(answerStr);
                    
                    // åˆ¤æ–­é¢˜å‹
                    let type = 'single';
                    if (mapType && row[mapType]) {
                        const typeStr = String(row[mapType]).toLowerCase();
                        if (typeStr.includes('å¤šé€‰') || typeStr.includes('multiple')) {
                            type = 'multiple';
                        }
                    } else if (Array.isArray(answer) && answer.length > 1) {
                        type = 'multiple';
                    }
                    
                    // å•é€‰é¢˜ç­”æ¡ˆè½¬ä¸ºå•ä¸ªæ•°å­—
                    if (type === 'single' && Array.isArray(answer)) {
                        answer = answer[0];
                    }
                    
                    const q = {
                        id: mapId ? (row[mapId] || index + 1) : index + 1,
                        type: type,
                        question: String(question).trim(),
                        options: options,
                        answer: answer
                    };
                    
                    if (mapCategory && row[mapCategory]) {
                        q.category = String(row[mapCategory]).trim();
                    }
                    
                    if (mapExplanation && row[mapExplanation]) {
                        q.explanation = String(row[mapExplanation]).trim();
                    }
                    
                    questions.push(q);
                    
                } catch (err) {
                    errorCount++;
                    console.error(`ç¬¬${index + 2}è¡Œè½¬æ¢å¤±è´¥:`, err);
                }
            });
            
            // ç”Ÿæˆä»£ç 
            const code = `// é¢˜åº“æ•°æ®æ–‡ä»¶
// å…± ${questions.length} é“é¢˜ç›®
// ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}

window.QUESTIONS = ${JSON.stringify(questions, null, 4)};`;
            
            document.getElementById('outputCode').textContent = code;
            document.getElementById('resultSection').style.display = 'block';
            
            const statusEl = document.getElementById('statusMessage');
            if (errorCount > 0) {
                statusEl.className = 'status error';
                statusEl.textContent = `è½¬æ¢å®Œæˆï¼æˆåŠŸ ${questions.length} é“ï¼Œå¤±è´¥ ${errorCount} é“`;
            } else {
                statusEl.className = 'status success';
                statusEl.textContent = `è½¬æ¢æˆåŠŸï¼å…± ${questions.length} é“é¢˜ç›®`;
            }
            
            // æ»šåŠ¨åˆ°ç»“æœ
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // è§£æç­”æ¡ˆå­—æ¯
        function parseAnswer(str) {
            const letterMap = { 'A': 0, 'B': 1, 'C': 2, 'D': 3, 'E': 4, 'F': 5 };
            const answers = [];
            
            for (let char of str) {
                if (letterMap[char] !== undefined) {
                    answers.push(letterMap[char]);
                }
            }
            
            return answers.length === 1 ? answers[0] : answers;
        }
        
        // å¤åˆ¶ä»£ç 
        function copyCode() {
            const code = document.getElementById('outputCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\nè¯·ç²˜è´´åˆ° questions.js æ–‡ä»¶ä¸­æ›¿æ¢åŸæœ‰å†…å®¹ã€‚');
            }).catch(() => {
                // é™çº§æ–¹æ¡ˆ
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('ä»£ç å·²å¤åˆ¶ï¼');
            });
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadFile() {
            const code = document.getElementById('outputCode').textContent;
            const blob = new Blob([code], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'questions.js';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
